name: SDK

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      SDK_VERSIONS:
        description: "List of SDK versions"
        value: ${{ jobs.collect_sdks.outputs.SDK_VERSIONS }}

jobs:
  package_sdk:
    name: Package SDK
    strategy:
      fail-fast: false
      matrix:
        macos_versions:
          - 14
          - 15
          - 26
    runs-on: macos-${{ matrix.macos_versions }}
    steps:
      - uses: actions/checkout@v6

      - name: SDK Package
        run: |
          xcode-select -p
          xcodebuild -version
          xcodebuild -showsdks
          ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV
          for xcode in $(ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV); do
            sed 's|for SDK in $SDKS; do|for SDK in $SDKS; do\n[ -f "$WDIR/$SDK$SDK_EXT" ] \&\& continue|g' tools/gen_sdk_package.sh | \
            XCODEDIR=/Applications/$xcode SDK_COMPRESSOR=xz bash
          done
          mkdir -p sdk-${{ matrix.macos_versions }}
          mv *.sdk.tar.xz sdk-${{ matrix.macos_versions }}
      - name: Upload SDK
        id: upload_sdk
        uses: actions/upload-artifact@v6
        with:
          name: sdk-${{ matrix.macos_versions }}
          path: sdk-${{ matrix.macos_versions }}
          compression-level: 0

  collect_sdks:
    name: Collect SDKs
    runs-on: ubuntu-latest
    needs: package_sdk
    outputs:
      SDK_VERSIONS: ${{ steps.get_all_sdk_versions.outputs.result }}
    steps:
      - name: Download SDK artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: 'sdk-*'
          merge-multiple: false

      - name: Collect and upload SDKs
        shell: bash
        run: |
          # Move SDK files from artifact folders to current directory
          for folder in sdk-*; do
            if [ -d "$folder" ]; then
              echo "Processing folder: $folder"
              for file in "$folder"/*.sdk.tar.xz; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "Moving $file to $filename"
                  mv "$file" "$filename"
                fi
              done
            fi
          done

          # List SDK files for verification
          ls -la *.sdk.tar.xz 2>/dev/null || echo "No SDK files found"

          # Create individual artifact uploads for each SDK
          for file in MacOSX*.sdk.tar.xz; do
            if [ -f "$file" ]; then
              # Extract version (MacOSX10.13.sdk.tar.xz -> 10-13)
              name=$(echo "$file" | sed 's/\.sdk\.tar\.xz$//')
              name=$(echo "$name" | sed 's/\./-/g')
              artifact_name=$(echo "$name" | sed 's/^MacOSX-*//')
              if [ -n "$artifact_name" ]; then
                echo "Will upload $file as artifact: $artifact_name"
                # Create a marker file for this artifact
                mkdir -p "/tmp/artifacts/$artifact_name"
                cp "$file" "/tmp/artifacts/$artifact_name/"
              fi
            fi
          done

      - name: Upload SDK artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sdk-files-collected
          path: MacOSX*.sdk.tar.xz
          compression-level: 0
          if-no-files-found: error

      - name: Get all SDK Versions
        id: get_all_sdk_versions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('.').filter(file =>
              file.endsWith('.sdk.tar.xz') && file.startsWith('MacOSX')
            );
            const sdk_versions = files.map(file => {
              // Convert MacOSX10.13.sdk.tar.xz to 10-13
              const name = file.replace(/\.sdk\.tar\.xz$/, '');
              return name.replace(/^MacOSX/, '').replace(/\./g, '-');
            }).filter(name => name && name !== '');
            console.log('SDK versions:', sdk_versions);
            return sdk_versions;

      - name: Upload individual SDK artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const path = require('path');
            
            // Install @actions/artifact with CommonJS compatibility
            execSync('npm install @actions/artifact@1.1.2');
            const artifact = require('@actions/artifact');
            const artifactClient = artifact.create();
            
            // Upload each SDK from /tmp/artifacts/ as a separate artifact
            const artifactsDir = '/tmp/artifacts';
            if (!fs.existsSync(artifactsDir)) {
              console.log('No /tmp/artifacts directory found');
              return;
            }
            
            const sdkDirs = fs.readdirSync(artifactsDir).filter(name =>
              fs.statSync(path.join(artifactsDir, name)).isDirectory()
            );
            
            for (const sdkVersion of sdkDirs) {
              const sdkPath = path.join(artifactsDir, sdkVersion);
              const files = fs.readdirSync(sdkPath).filter(f => f.endsWith('.sdk.tar.xz'));
              
              if (files.length > 0) {
                const filePath = path.join(sdkPath, files[0]);
                console.log(`Uploading ${filePath} as artifact ${sdkVersion}`);
                
                try {
                  await artifactClient.uploadArtifact(
                    sdkVersion,
                    [filePath],
                    artifactsDir,
                    { continueOnError: false }
                  );
                  console.log(`Successfully uploaded artifact ${sdkVersion}`);
                } catch (error) {
                  console.error(`Failed to upload ${sdkVersion}:`, error);
                  throw error;
                }
              }
            }

