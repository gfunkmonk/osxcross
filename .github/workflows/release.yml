---
name: Release osxcross

on: workflow_dispatch
jobs:
  package_sdks:
    uses: ./.github/workflows/sdk.yml
  build_apple_clang:
    name: Build Apple Clang
    strategy:
      fail-fast: false
      matrix:
        ubuntu_version:
          - 20.04
          - 22.04
          - 24.04
        runs-on:
          - ubuntu-latest
          - ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v6
      - name: Create Apple Clang build script
        run: |
          cat > build_apple_clang_script.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Building Apple Clang for Ubuntu $1"
          echo "Architecture: $(uname -m)"
          # Update package list and install dependencies
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y \
            curl \
            wget \
            make \
            cmake \
            unzip \
            git \
            patch \
            python3 \
            libssl-dev \
            lzma-dev \
            libxml2-dev \
            xz-utils \
            bzip2 \
            cpio \
            zlib1g-dev \
            llvm-dev \
            uuid-dev \
            lsb-release \
            software-properties-common \
            gnupg \
            build-essential \
            ninja-build
          # Download and install CMake
          mkdir -p /cmake
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.8/cmake-3.31.8-linux-x86_64.tar.gz | tar -xz -C /cmake --strip-components=1
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ];
          then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.8/cmake-3.31.8-linux-aarch64.tar.gz | tar -xz -C /cmake --strip-components=1
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          export PATH=/cmake/bin:$PATH
          # Build Apple Clang
          export INSTALLPREFIX=/usr/local/apple-clang
          export CLANG_VERSION=21
          UNATTENDED=1 ENABLE_CLANG_INSTALL=1 PORTABLE=1 JOBS=$(nproc) bash
          build_apple_clang.sh
          # Create distribution package
          mkdir -p dist
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            tar -zcf dist/apple-clang-21-linux-x86_64-gnu-ubuntu-$1.tar.gz -C $INSTALLPREFIX .
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ];
          then
            tar -zcf dist/apple-clang-21-linux-aarch64-gnu-ubuntu-$1.tar.gz -C $INSTALLPREFIX .
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          EOF
          chmod +x build_apple_clang_script.sh
      - name: Build Apple Clang
        run: |
          docker run --rm \
            --volume "${PWD}:/osxcross" \
            --workdir /osxcross \
            ubuntu:${{ matrix.ubuntu_version }} \
            /bin/bash -c "/osxcross/build_apple_clang_script.sh '${{ matrix.ubuntu_version }}'"
      - name: Upload Apple Clang artifact
        uses: actions/upload-artifact@v6
        with:
          name: >-
            apple-clang-${{ matrix.ubuntu_version }}-${{ matrix.runs-on ==
            'ubuntu-24.04-arm' && 'aarch64' || 'x86_64' }}
          path: dist/*
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
            dist/*
  release_sdks:
    name: Release SDKs
    runs-on: ubuntu-latest
    needs: package_sdks
    steps:
      - uses: actions/checkout@v6
      - name: Clear tarballs
        run: |
          rm -rf tarballs/* || true
          rm -rf tarballs/.* || true
      - name: Download SDKs
        uses: actions/download-artifact@v4
        with:
          pattern: '[0-9]*'
          path: tarballs
          merge-multiple: true
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
            tarballs/*
  build_osxcross:
    name: Build osxcross
    strategy:
      fail-fast: false
      matrix:
        sdk_versions: ${{ fromJSON(needs.package_sdks.outputs.SDK_VERSIONS) }}
        ubuntu_version:
          - 20.04
          - 22.04
          - 24.04
        runs-on:
          - ubuntu-latest
          - ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}
    needs:
      - package_sdks
      - release_sdks
      - build_apple_clang
    steps:
      - uses: actions/checkout@v6
      - name: Download SDK
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.sdk_versions }}
          path: tarballs
      - name: Download Apple Clang
        uses: actions/download-artifact@v4
        with:
          name: >-
            apple-clang-${{ matrix.ubuntu_version }}-${{ matrix.runs-on ==
            'ubuntu-24.04-arm' && 'aarch64' || 'x86_64' }}
          path: apple-clang
      - name: Create build script
        run: |
          cat > build_script.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "Building osxcross for Ubuntu $1 with SDK $2"
          echo "Architecture: $(uname -m)"
          # Update package list and install dependencies
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y \
            curl \
            wget \
            make \
            cmake \
            unzip \
            git \
            patch \
            python3 \
            libssl-dev \
            lzma-dev \
            libxml2-dev \
            xz-utils \
            bzip2 \
            cpio \
            zlib1g-dev \
            llvm-dev \
            uuid-dev \
            lsb-release \
            software-properties-common \
            gnupg \
            build-essential \
            ninja-build
          export TARGET_DIR=/usr/local/osxcross
          CLANG_DIR=$TARGET_DIR/clang
          mkdir -p $CLANG_DIR
          # Extract and setup Apple Clang
          tar -xzf /osxcross/apple-clang/*.tar.gz -C $CLANG_DIR
          export PATH=$CLANG_DIR/bin:$PATH
          # Download and install CMake
          mkdir -p /cmake
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.8/cmake-3.31.8-linux-x86_64.tar.gz | tar -xz -C /cmake --strip-components=1
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ];
          then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.8/cmake-3.31.8-linux-aarch64.tar.gz | tar -xz -C /cmake --strip-components=1
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          export PATH=/cmake/bin:$PATH
          # Build osxcross
          export IPHONEOS_DEPLOYMENT_TARGET=5.0
          UNATTENDED=1 SDK_VERSION="$(echo $2 | sed 's/-/./g')" JOBS=$(nproc)
          bash build.sh
          # Create distribution package
          mkdir -p dist
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            tar -zcf dist/osxcross-$2-linux-x86_64-gnu-ubuntu-$1.tar.gz -C $TARGET_DIR .
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ];
          then
            tar -zcf dist/osxcross-$2-linux-aarch64-gnu-ubuntu-$1.tar.gz -C $TARGET_DIR .
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          EOF
          chmod +x build_script.sh
      - name: Build osxcross
        run: |
          docker run --rm \
            --volume "${PWD}:/osxcross" \
            --workdir /osxcross \
            ubuntu:${{ matrix.ubuntu_version }} \
            /bin/bash -c "/osxcross/build_script.sh '${{ matrix.ubuntu_version }}' '${{ matrix.sdk_versions }}'"
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
