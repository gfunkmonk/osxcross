name: SDK

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      SDK_VERSIONS:
        description: "List of SDK versions"
        value: ${{ jobs.collect_sdks.outputs.SDK_VERSIONS }}

jobs:
  package_sdk:
    name: Package SDK
    strategy:
      fail-fast: false
      matrix:
        macos_versions:
          - 14
          - 15
          - 26
    runs-on: macos-${{ matrix.macos_versions }}
    steps:
      - uses: actions/checkout@v6

      - name: SDK Package
        run: |
          xcode-select -p
          xcodebuild -version
          xcodebuild -showsdks
          ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV
          for xcode in $(ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV); do
            sed 's|for SDK in $SDKS; do|for SDK in $SDKS; do\n[ -f "$WDIR/$SDK$SDK_EXT" ] \&\& continue|g' tools/gen_sdk_package.sh | \
            XCODEDIR=/Applications/$xcode SDK_COMPRESSOR=xz bash
          done
          mkdir -p sdk-${{ matrix.macos_versions }}
          mv *.sdk.tar.xz sdk-${{ matrix.macos_versions }}
      - name: Upload SDK
        id: upload_sdk
        uses: actions/upload-artifact@v6
        with:
          name: sdk-${{ matrix.macos_versions }}
          path: sdk-${{ matrix.macos_versions }}
          compression-level: 0

  collect_sdks:
    name: Collect SDKs
    runs-on: ubuntu-latest
    needs: package_sdk
    outputs:
      SDK_VERSIONS: ${{ steps.get_all_sdk_versions.outputs.result }}
    steps:
      - name: Download SDK artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: 'sdk-*'
          merge-multiple: false

      - name: Collect and upload SDKs
        shell: bash
        run: |
          # Move SDK files from artifact folders to current directory
          for folder in sdk-*; do
            if [ -d "$folder" ]; then
              echo "Processing folder: $folder"
              for file in "$folder"/*.sdk.tar.xz; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "Moving $file to $filename"
                  mv "$file" "$filename"
                fi
              done
            fi
          done

          # List SDK files for verification
          ls -la *.sdk.tar.xz 2>/dev/null || echo "No SDK files found"

      - name: Get all SDK Versions
        id: get_all_sdk_versions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('.').filter(file =>
              file.endsWith('.sdk.tar.xz') && file.startsWith('MacOSX')
            );
            const sdk_versions = files.map(file => {
              // Convert MacOSX10.13.sdk.tar.xz to 10-13
              const name = file.replace(/\.sdk\.tar\.xz$/, '');
              return name.replace(/^MacOSX/, '').replace(/\./g, '-');
            }).filter(name => name && name !== '');
            console.log('SDK versions:', sdk_versions);
            return sdk_versions;

      - name: Upload individual SDK artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { DefaultArtifactClient } = require('@actions/artifact');
            const artifact = new DefaultArtifactClient();
            
            const files = fs.readdirSync('.').filter(file =>
              file.endsWith('.sdk.tar.xz') && file.startsWith('MacOSX')
            );
            
            for (const file of files) {
              // Convert MacOSX10.13.sdk.tar.xz to 10-13
              const sdkVersion = file
                .replace(/\.sdk\.tar\.xz$/, '')
                .replace(/^MacOSX/, '')
                .replace(/\./g, '-');
              
              console.log(`Uploading ${file} as artifact ${sdkVersion}`);
              
              await artifact.uploadArtifact(
                sdkVersion,
                [file],
                '.',
                { compressionLevel: 0 }
              );
            }

