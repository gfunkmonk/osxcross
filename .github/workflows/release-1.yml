---
name: Release osxcross-1

on:
  workflow_dispatch:
    inputs:
      freespace:
        description: 'Clear Disk Space'
        required: true
        type: boolean
        default: false
      swapspace:
        description: 'Add Swap File'
        required: true
        type: boolean
        default: false
      sdk_14:
        description: 'Build macOS 14 SDKs'
        required: false
        type: boolean
        default: true
      sdk_15:
        description: 'Build macOS 15 SDKs'
        required: false
        type: boolean
        default: true
      sdk_26:
        description: 'Build macOS 26 SDKs'
        required: false
        type: boolean
        default: true
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  package_sdks:
    uses: ./.github/workflows/sdk.yml
    with:
      sdk_14: ${{ inputs.sdk_14 }}
      sdk_15: ${{ inputs.sdk_15 }}
      sdk_26: ${{ inputs.sdk_26 }}
  build_apple_clang:
    name: Build Apple Clang
    strategy:
      fail-fast: false
      matrix:
        ubuntu_version: [24.04]
        runs-on: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.runs-on }}
    steps:
      - if: ${{ inputs.freespace }}
        name: Clear up some disk space
        uses: jlumbroso/free-disk-space@main
        with:
          swap-storage: true
          large-packages: true
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          docker-images: true
      - uses: actions/checkout@v4
      - name: Cache Apple Clang build
        id: cache-apple-clang
        uses: actions/cache/restore@v4
        with:
          path: dist/
          key: apple-clang-21-ubuntu-${{ matrix.ubuntu_version }}-${{ matrix.runs-on }}-${{ hashFiles('build_apple_clang.sh', 'build_clang.sh', '.github/workflows/release.yml') }}
          restore-keys: |
            apple-clang-21-ubuntu-${{ matrix.ubuntu_version }}-${{ matrix.runs-on }}
      - if: ${{ inputs.swapspace }}
        name: Set up swap space
        uses: thejerrybao/setup-swap-space@v1
        with:
          swap-space-path: /mnt/swapfile
          swap-size-gb: 8
          remove-existing-swap-files: true
      - name: Setup ccache
        run: |
          # Setup CCACHE
          sudo mkdir -p /mnt/ccache
          sudo chown -R $USER:$USER /mnt/ccache
          cat >> $GITHUB_ENV << 'EOF'
          CCACHE_DIR=/mnt/ccache
          CCACHE_MAXSIZE=10.0GiB
          CCACHE_NOHASHDIR=true
          CCACHE_NOHARDLINK=true
          CCACHE_NLEVELS=4
          CCACHE_COMPILERCHECK=content
          CCACHE_COMPRESS=1
          CCACHE_COMPRESSLEVEL=7
          CCACHE_INODECACHE=true
          CCACHE_RECACHE=true
          CCACHE_SLOPINESS=file_macro,locale,time_macros
          CCACHE_NOFILECLONE=true
          CCACHE_DIRECT=true
          CCACHE_DEPEND=true
          EOF
          echo "CCACHE Environment set!"
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          verbose: 1
          max-size: 10000MB
          key: ccache-${{ matrix.runs-on }}
      #- name: Enable ccache
      #  uses: Chocobo1/setup-ccache-action@v1
      #  with:
      #    update_packager_index: true
      #    install_ccache: true
      #    prepend_symlinks_to_path: true
      #    ccache_options: |
      #      max_size=10000M
      #      cache_dir=/mnt/ccache
      #- name: ðŸ” ðŸ„¢ðŸ„¢ðŸ„— â’±â’¤â’œ ðŸ„’â’§â’ªâ’°â’Ÿâ’¡â’§â’œâ’­â’ 
      #  uses: valeriangalliat/action-sshd-cloudflared@v1
      - name: Build Apple Clang
        if: steps.cache-apple-clang.outputs.cache-hit != 'true'
        run: |
          echo "Building Apple Clang for Ubuntu ${{ matrix.ubuntu_version }}"
          echo "Architecture: $(uname -m)"
          # Update package list and install dependencies
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update && sudo apt-get install -y \
            curl \
            wget \
            make \
            cmake \
            unzip \
            git \
            patch \
            python3 \
            libssl-dev \
            lzma-dev \
            libxml2-dev \
            xz-utils \
            pixz \
            bzip2 \
            cpio \
            zlib1g-dev \
            llvm-dev \
            uuid-dev \
            lsb-release \
            software-properties-common \
            gnupg \
            build-essential \
            ninja-build \
            ccache
          # Download and install CMake
          sudo mkdir -p /cmake
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.10/cmake-3.31.10-linux-x86_64.tar.gz | sudo tar -xz -C /cmake --strip-components=1
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.10/cmake-3.31.10-linux-aarch64.tar.gz | sudo tar -xz -C /cmake --strip-components=1
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          export PATH=/cmake/bin:$PATH
          # Build Apple Clang
          export INSTALLPREFIX="/usr/local/apple-clang"
          export CLANG_VERSION="21"

          UNATTENDED=1 ENABLE_CLANG_INSTALL=1 PORTABLE=1 JOBS=$(nproc) bash ./build_apple_clang.sh
          # Create distribution package
          sudo mkdir -p dist
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            sudo tar -zcf dist/apple-clang-21-linux-x86_64-gnu-ubuntu-${{ matrix.ubuntu_version }}.tar.gz -C $INSTALLPREFIX .
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ]; then
            sudo tar -zcf dist/apple-clang-21-linux-aarch64-gnu-ubuntu-${{ matrix.ubuntu_version }}.tar.gz -C $INSTALLPREFIX .
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
      - name: Save Apple Clang build cache
        uses: actions/cache/save@v4
        if: steps.cache-apple-clang.outputs.cache-hit != 'true'
        with:
          path: dist/
          key: ${{ steps.cache-apple-clang.outputs.cache-primary-key }}
      - name: Upload Apple Clang artifact
        uses: actions/upload-artifact@v4
        with:
          name: apple-clang-${{ matrix.ubuntu_version }}-${{ matrix.runs-on == 'ubuntu-24.04-arm' && 'aarch64' || 'x86_64' }}
          path: dist/*
          overwrite: true
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
            dist/*
  release_sdks:
    name: Release SDKs
    runs-on: ubuntu-latest
    needs: package_sdks
    steps:
      - uses: actions/checkout@v4
      - name: Clear tarballs
        run: |
          rm -rf tarballs/* || true
          rm -rf tarballs/.* || true
      - name: Download SDKs
        uses: actions/download-artifact@v4
        with:
          name: all-sdks
          path: tarballs
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
            tarballs/*
  build_osxcross:
    name: Build osxcross
    strategy:
      fail-fast: false
      matrix:
        sdk_versions: ${{ fromJSON(needs.package_sdks.outputs.SDK_VERSIONS) }}
        ubuntu_version: [24.04]
        runs-on: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.runs-on }}
    needs:
      - package_sdks
      - release_sdks
      - build_apple_clang
    steps:
      - uses: actions/checkout@v4
      - name: Download SDK
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.sdk_versions }}
          path: tarballs
      - name: Download Apple Clang
        uses: actions/download-artifact@v4
        with:
          name: apple-clang-${{ matrix.ubuntu_version }}-${{ matrix.runs-on == 'ubuntu-24.04-arm' && 'aarch64' || 'x86_64' }}
          path: apple-clang
      - name: Cache osxcross build
        id: cache-osxcross
        uses: actions/cache/restore@v4
        with:
          path: dist/
          key: osxcross-ubuntu-${{ matrix.sdk_versions }}-${{ matrix.runs-on }}-${{ hashFiles('build.sh', '.github/workflows/release.yml') }}
          restore-keys: |
            osxcross-ubuntu-${{ matrix.sdk_versions }}-${{ matrix.runs-on }}
      - name: Run build script
        if: steps.cache-osxcross.outputs.cache-hit != 'true'
        run: |
          echo "Building osxcross for Ubuntu ${{ matrix.ubuntu_version }} with SDK ${{ matrix.sdk_versions }}"
          echo "Architecture: $(uname -m)"
          # Update package list and install dependencies
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update && sudo apt-get install -y \
            curl \
            wget \
            make \
            cmake \
            unzip \
            git \
            patch \
            python3 \
            libssl-dev \
            lzma-dev \
            libxml2-dev \
            pixz \
            xz-utils \
            bzip2 \
            cpio \
            zlib1g-dev \
            llvm-dev \
            uuid-dev \
            lsb-release \
            software-properties-common \
            gnupg \
            build-essential \
            ninja-build \
            ccache
          export TARGET_DIR=/usr/local/osxcross
          CLANG_DIR=$TARGET_DIR/clang
          sudo mkdir -p $CLANG_DIR
          # Extract and setup Apple Clang
          sudo tar -xzf ./apple-clang/*.tar.gz -C $CLANG_DIR
          export PATH=$CLANG_DIR/bin:$PATH
          # Download and install CMake
          sudo mkdir -p /cmake
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.10/cmake-3.31.10-linux-x86_64.tar.gz | sudo tar -xz -C /cmake --strip-components=1
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ]; then
            curl -sSL https://github.com/Kitware/CMake/releases/download/v3.31.10/cmake-3.31.10-linux-aarch64.tar.gz | sudo tar -xz -C /cmake --strip-components=1
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
          export PATH=/cmake/bin:$PATH
          # Build osxcross
          SDK_VERSION_DOTS=$(echo "${{ matrix.sdk_versions }}" | sed 's/-/./g')
          UNATTENDED=1 SDK_VERSION="$SDK_VERSION_DOTS" JOBS=$(nproc) sudo -E bash ./build.sh
          # Create distribution package
          mkdir -p dist
          if [ "$(uname -m)" = "x86_64" ] || [ "$(uname -m)" = "amd64" ]; then
            tar -zcf dist/osxcross-${{ matrix.sdk_versions }}-linux-x86_64-gnu-ubuntu-${{ matrix.ubuntu_version }}.tar.gz -C $TARGET_DIR .
          elif [ "$(uname -m)" = "aarch64" ] || [ "$(uname -m)" = "arm64" ]; then
            tar -zcf dist/osxcross-${{ matrix.sdk_versions }}-linux-aarch64-gnu-ubuntu-${{ matrix.ubuntu_version }}.tar.gz -C $TARGET_DIR .
          else
            echo "Unsupported architecture: $(uname -m)"
            exit 1
          fi
      - name: Save osxcross build cache
        uses: actions/cache/save@v4
        if: steps.cache-osxcross.outputs.cache-hit != 'true'
        with:
          path: dist/
          key: ${{ steps.cache-osxcross.outputs.cache-primary-key }}
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          append_body: false
          fail_on_unmatched_files: true
          files: |
            dist/*
