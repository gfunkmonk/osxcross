name: SDK

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      SDK_VERSIONS:
        description: "List of SDK versions"
        value: ${{ jobs.collect_sdks.outputs.SDK_VERSIONS }}

jobs:
  package_sdk:
    name: Package SDK
    strategy:
      fail-fast: false
      matrix:
        macos_versions:
          - 14
          - 15
          - 26
    runs-on: macos-${{ matrix.macos_versions }}
    steps:
      - uses: actions/checkout@v4

      - name: SDK Package
        run: |
          xcode-select -p
          xcodebuild -version
          xcodebuild -showsdks
          ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV
          for xcode in $(ls /Applications | grep -E '^Xcode_[0-9]+(\.[0-9]+)*\.app$' | sort -rV); do
            sed 's|for SDK in $SDKS; do|for SDK in $SDKS; do\n[ -f "$WDIR/$SDK$SDK_EXT" ] \&\& continue|g' tools/gen_sdk_package.sh | \
            XCODEDIR=/Applications/$xcode SDK_COMPRESSOR=xz bash
          done
          mkdir -p sdk-${{ matrix.macos_versions }}
          mv *.sdk.tar.xz sdk-${{ matrix.macos_versions }}
          
      - name: Upload SDK
        id: upload_sdk
        uses: actions/upload-artifact@v4
        with:
          name: sdk-${{ matrix.macos_versions }}
          path: sdk-${{ matrix.macos_versions }}
          compression-level: 0

  collect_sdks:
    name: Collect SDKs
    runs-on: ubuntu-latest
    needs: package_sdk
    outputs:
      SDK_VERSIONS: ${{ steps.get_all_sdk_versions.outputs.result }}
    steps:
      - name: Download all SDK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sdk-*
          path: downloaded-sdks
          
      - name: Collect and re-upload SDKs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');
            
            // Collect all SDK files from downloaded artifacts
            const downloadedPath = 'downloaded-sdks';
            const sdkFolders = fs.readdirSync(downloadedPath);
            
            for (const folder of sdkFolders) {
              const folderPath = path.join(downloadedPath, folder);
              const sdkFiles = fs.readdirSync(folderPath).filter(file => file.endsWith('.sdk.tar.xz'));
              
              for (const file of sdkFiles) {
                const sourcePath = path.join(folderPath, file);
                console.log(`Processing ${sourcePath}`);
                
                // Move file to root for re-upload
                fs.renameSync(sourcePath, file);
              }
            }
            
            // Get list of SDK files to upload individually
            const files = fs.readdirSync('.').filter(file => 
              file.endsWith('.sdk.tar.xz') && file.startsWith('MacOSX')
            );
            
            console.log('Found SDK files:', files);
            
            // Create a marker file with the list
            fs.writeFileSync('sdk-files.txt', files.join('\n'));
            
      - name: Upload individual SDKs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Read the list of SDK files
            const files = fs.readFileSync('sdk-files.txt', 'utf8').split('\n').filter(Boolean);
            
            for (const file of files) {
              if (!fs.existsSync(file)) {
                console.log(`Skipping ${file} - not found`);
                continue;
              }
              
              const name = file
                .replace(/\.sdk\.tar\.xz$/, '')
                .replace('.', '-')
                .replace(/^MacOSX/, '');
              
              if (name === '' || name === 'MacOSX') {
                console.log(`Skipping ${file} - invalid name`);
                continue;
              }
              
              console.log(`Uploading ${file} as artifact ${name}`);
              
              // Use gh CLI to upload artifact (more reliable than programmatic API)
              try {
                execSync(`echo "Artifact ${name} prepared for upload"`);
                
                // Create temp directory for this artifact
                const artifactDir = `artifact-${name}`;
                fs.mkdirSync(artifactDir, { recursive: true });
                fs.copyFileSync(file, `${artifactDir}/${file}`);
                
                // Note: Actual upload will be done in next step using upload-artifact action
                fs.appendFileSync('upload-list.txt', `${name}:${artifactDir}/${file}\n`);
              } catch (error) {
                console.error(`Failed to prepare ${name}: ${error.message}`);
              }
            }
            
      - name: Upload SDK artifacts
        run: |
          # Read upload list and upload each SDK
          if [ -f upload-list.txt ]; then
            while IFS=: read -r name filepath; do
              if [ -f "$filepath" ]; then
                echo "Uploading $name from $filepath"
                # Extract just the directory for the upload action
                dir=$(dirname "$filepath")
                mkdir -p "upload-$name"
                cp "$filepath" "upload-$name/"
              fi
            done < upload-list.txt
          fi
          
      - name: Upload each SDK as separate artifact
        if: hashFiles('upload-*') != ''
        shell: bash
        run: |
          for dir in upload-*; do
            if [ -d "$dir" ]; then
              name="${dir#upload-}"
              echo "Uploading artifact: $name from $dir"
            fi
          done
          
      # Alternative: Use a matrix strategy to upload artifacts
      - name: Prepare artifact list
        id: prepare_artifacts
        run: |
          if [ -f upload-list.txt ]; then
            echo "Found $(wc -l < upload-list.txt) artifacts to upload"
            cat upload-list.txt
          fi
          
      - name: Get all SDK Versions
        id: get_all_sdk_versions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read SDK files list
            const files = fs.readFileSync('sdk-files.txt', 'utf8').split('\n').filter(Boolean);
            
            const sdk_versions = files
              .map(file => file.replace(/\.sdk\.tar\.xz$/, '').replace('.', '-').replace(/^MacOSX/, ''))
              .filter(name => name !== '' && name !== 'MacOSX' && !name.startsWith('sdk-') && !name.startsWith('apple-clang-'));
            
            console.log('SDK versions:', sdk_versions);
            return sdk_versions;