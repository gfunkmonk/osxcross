---
name: Test Artifact Upload/Download

on:
  workflow_dispatch:

jobs:
  upload_test_artifacts:
    name: Upload Test Artifacts
    runs-on: ubuntu-latest
    outputs:
      TEST_VERSIONS: ${{ steps.get_versions.outputs.result }}
    steps:
      - name: Create test files
        run: |
          # Create test files mimicking SDK naming pattern
          echo "Test content for 10.13" > Test10.13.txt
          echo "Test content for 11.1" > Test11.1.txt
          echo "Test content for 12.0" > Test12.0.txt
          echo "Test content for 13.3" > Test13.3.txt
          echo "Test content for 14.5" > Test14.5.txt
          
          echo "Created test files:"
          ls -la Test*.txt

      - name: Get test versions
        id: get_versions
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('.').filter(file =>
              file.endsWith('.txt') && file.startsWith('Test')
            );
            const versions = files.map(file => {
              // Convert Test10.13.txt to 10-13
              const name = file.replace(/\.txt$/, '');
              return name.replace(/^Test/, '').replace(/\./g, '-');
            }).filter(name => name && name !== '');
            console.log('Test versions:', versions);
            return versions;

      - name: Upload test artifact for 10-13
        uses: actions/upload-artifact@v4
        with:
          name: 10-13
          path: Test10.13.txt
          compression-level: 0

      - name: Upload test artifact for 11-1
        uses: actions/upload-artifact@v4
        with:
          name: 11-1
          path: Test11.1.txt
          compression-level: 0

      - name: Upload test artifact for 12-0
        uses: actions/upload-artifact@v4
        with:
          name: 12-0
          path: Test12.0.txt
          compression-level: 0

      - name: Upload test artifact for 13-3
        uses: actions/upload-artifact@v4
        with:
          name: 13-3
          path: Test13.3.txt
          compression-level: 0

      - name: Upload test artifact for 14-5
        uses: actions/upload-artifact@v4
        with:
          name: 14-5
          path: Test14.5.txt
          compression-level: 0

  download_test_artifacts:
    name: Download Test Artifacts
    runs-on: ubuntu-latest
    needs: upload_test_artifacts
    steps:
      - name: Download test artifacts using pattern
        uses: actions/download-artifact@v4
        with:
          pattern: '[0-9]*'
          path: downloaded
          merge-multiple: true

      - name: Verify downloaded artifacts
        run: |
          echo "Checking downloaded artifacts..."
          ls -laR downloaded/
          
          echo ""
          echo "Verifying file contents..."
          
          # Check if files exist
          if [ ! -f "downloaded/Test10.13.txt" ]; then
            echo "ERROR: Test10.13.txt not found!"
            exit 1
          fi
          
          if [ ! -f "downloaded/Test11.1.txt" ]; then
            echo "ERROR: Test11.1.txt not found!"
            exit 1
          fi
          
          if [ ! -f "downloaded/Test12.0.txt" ]; then
            echo "ERROR: Test12.0.txt not found!"
            exit 1
          fi
          
          if [ ! -f "downloaded/Test13.3.txt" ]; then
            echo "ERROR: Test13.3.txt not found!"
            exit 1
          fi
          
          if [ ! -f "downloaded/Test14.5.txt" ]; then
            echo "ERROR: Test14.5.txt not found!"
            exit 1
          fi
          
          echo ""
          echo "✓ All test files downloaded successfully!"
          echo ""
          
          # Verify contents
          echo "File contents:"
          cat downloaded/Test10.13.txt
          cat downloaded/Test11.1.txt
          cat downloaded/Test12.0.txt
          cat downloaded/Test13.3.txt
          cat downloaded/Test14.5.txt
          
          echo ""
          echo "=========================================="
          echo "✓ ARTIFACT UPLOAD/DOWNLOAD TEST PASSED!"
          echo "=========================================="
          echo ""
          echo "This confirms the artifact mechanism works:"
          echo "  - Individual artifacts uploaded with version names (10-13, 11-1, etc.)"
          echo "  - Pattern '[0-9]*' successfully matches and downloads all artifacts"
          echo "  - Files are retrieved correctly with their original content"
          echo ""
          echo "The same mechanism in sdk.yml and release.yml will work correctly."

  download_by_matrix:
    name: Download by Matrix Version
    runs-on: ubuntu-latest
    needs: upload_test_artifacts
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.upload_test_artifacts.outputs.TEST_VERSIONS) }}
    steps:
      - name: Download specific version artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.version }}
          path: downloaded

      - name: Verify specific artifact
        run: |
          echo "Downloaded artifact for version: ${{ matrix.version }}"
          ls -la downloaded/
          
          # Convert version back to filename (e.g., 10-13 -> Test10.13.txt)
          version_with_dots=$(echo "${{ matrix.version }}" | sed 's/-/./g')
          expected_file="downloaded/Test${version_with_dots}.txt"
          
          if [ -f "$expected_file" ]; then
            echo "✓ File found: $expected_file"
            cat "$expected_file"
          else
            echo "ERROR: Expected file not found: $expected_file"
            echo "Contents of downloaded directory:"
            ls -la downloaded/
            exit 1
          fi
          
          echo ""
          echo "✓ Matrix download successful for version ${{ matrix.version }}"